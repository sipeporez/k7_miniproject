package com.subway.service;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.springframework.stereotype.Service;

import com.subway.domain.dto.RequestStationDataDTO;
import com.subway.domain.dto.StationDTO;
import com.subway.persistence.BoardRepository;

import jakarta.persistence.EntityManager;
import jakarta.persistence.Query;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class StationService {
	private final BoardRepository br;
	private final EntityManager em;

	public List<StationDTO> getStationDataByDate(RequestStationDataDTO dto) {
        List<StationDTO> list = new ArrayList<>();
        
		Integer station_no = dto.getStation_no();
		List<Date> dates = dto.getDatelist();
		
		List<Object[]> objs = (br.getStationDataByDate(station_no, dates));
		for (Object[] obj : objs) {
			list.add(StationDTO.builder()
					.station_name(obj[0].toString())
					.date(obj[1].toString())
					.gubun((Byte) obj[2])
					.hour_01_02((Integer) obj[3])
					.hour_02_03((Integer) obj[4])
					.hour_03_04((Integer) obj[5])
					.hour_04_05((Integer) obj[6])
					.hour_05_06((Integer) obj[7])
					.hour_06_07((Integer) obj[8])
					.hour_07_08((Integer) obj[9])
					.hour_08_09((Integer) obj[10])
					.hour_09_10((Integer) obj[11])
					.hour_10_11((Integer) obj[12])
					.hour_11_12((Integer) obj[13])
					.hour_12_13((Integer) obj[14])
					.hour_13_14((Integer) obj[15])
					.hour_14_15((Integer) obj[16])
					.hour_15_16((Integer) obj[17])
					.hour_16_17((Integer) obj[18])
					.hour_17_18((Integer) obj[19])
					.hour_18_19((Integer) obj[20])
					.hour_19_20((Integer) obj[21])
					.hour_20_21((Integer) obj[22])
					.hour_21_22((Integer) obj[23])
					.hour_22_23((Integer) obj[24])
					.hour_23_24((Integer) obj[25])
					.hour_24_01((Integer) obj[26])
					.build());
		}
		return list;
	}
	public List<StationDTO> getStationDataByHours(RequestStationDataDTO dto) {
		
		List<StationDTO> list = new ArrayList<>();
		
		Integer station_no = dto.getStation_no();
		List<Date> dates = dto.getDatelist();
		List<String> hours = dto.getHourlist();
		
		SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd");
		String query = "SELECT sl.station_name, pc.date, pc.gubun";
				for (String h : hours) {query += ", "+ h;}
				query += " FROM passenger_count pc, station_list sl ";
				query += "WHERE pc.station_no = sl.station_no and pc.station_no = ";
				query += station_no;
				query += " AND pc.date in (";
				for (Date d : dates) {query +="'" + formatter.format(d) + "', ";}
				query = query.substring(0,query.length()-2);
				query += ")";
		Query sql = em.createNativeQuery(query);
		List<Object[]> result = sql.getResultList();
		for (Object result : sql.getResultList()) {
			
		}
		
		
		return (List<StationDTO>)sql.getResultList();
	}

}
